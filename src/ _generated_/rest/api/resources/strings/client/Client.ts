/**
 * This file was auto-generated by Fern from our API Definition.
 */

import * as environments from "../../../../environments";
import * as core from "../../../../core";
import * as Skyflow from "../../../index";
import urlJoin from "url-join";
import * as errors from "../../../../errors/index";

export declare namespace Strings {
    export interface Options {
        environment?: core.Supplier<environments.SkyflowEnvironment | string>;
        /** Specify a custom URL to connect the client to. */
        baseUrl?: core.Supplier<string>;
        token: core.Supplier<core.BearerToken>;
        fetcher?: core.FetchFunction;
    }

    export interface RequestOptions {
        /** The maximum time to wait for a response in seconds. */
        timeoutInSeconds?: number;
        /** The number of times to retry the request. Defaults to 2. */
        maxRetries?: number;
        /** A hook to abort the request. */
        abortSignal?: AbortSignal;
        /** Additional headers to include in the request. */
        headers?: Record<string, string>;
    }
}

export class Strings {
    constructor(protected readonly _options: Strings.Options) {}

    /**
     * De-identifies sensitive data from a string.
     *
     * @param {Skyflow.DeidentifyStringRequest} request
     * @param {Strings.RequestOptions} requestOptions - Request-specific configuration.
     *
     * @throws {@link Skyflow.BadRequestError}
     * @throws {@link Skyflow.UnauthorizedError}
     * @throws {@link Skyflow.InternalServerError}
     *
     * @example
     *     await client.strings.deidentifyString({
     *         vault_id: "f4b3b3b33b3b3b3b3b3b3b3b3b3b3b3b",
     *         text: "My name is John Doe, and my email is johndoe@acme.com."
     *     })
     *
     * @example
     *     await client.strings.deidentifyString({
     *         vault_id: "f4b3b3b33b3b3b3b3b3b3b3b3b3b3b3b",
     *         text: "S: 62yo female here for first visit. No concerns today. Her FP (Dr. Benyamin) is retiring soon. Up to date on pap, mammo, labs, BMD. On the waitlist for colonoscopy. Past Medical and Surgical hx: nil. Meds: nil. Allergies: Pn. Family and Social hx: see CPP. O: Temp 35.2;BP 145-73; HR 58. Appears well. A: First visit. P: CPP updated. RTC prn. A007. First visit. Type Name: Clinical Note"
     *     })
     *
     * @example
     *     await client.strings.deidentifyString({
     *         vault_id: "f4b3b3b33b3b3b3b3b3b3b3b3b3b3b3b",
     *         text: "My name is John Doe, and my email is johndoe@acme.com.",
     *         entity_types: ["name", "email_address"],
     *         token_type: {
     *             default: "entity_only"
     *         }
     *     })
     *
     * @example
     *     await client.strings.deidentifyString({
     *         vault_id: "VAULT_ID",
     *         text: "My name is John Doe, and my email is johndoe@acme.com.",
     *         token_type: {
     *             default: "vault_token"
     *         }
     *     })
     *
     * @example
     *     await client.strings.deidentifyString({
     *         vault_id: "VAULT_ID",
     *         text: "My name is John Doe, and my email is johndoe@acme.com."
     *     })
     *
     * @example
     *     await client.strings.deidentifyString({
     *         vault_id: "VAULT_ID",
     *         text: "My name is John, and my email is johndoe@acme.com.",
     *         entity_types: ["name", "email_address"],
     *         token_type: {
     *             default: "entity_only"
     *         },
     *         allow_regex: ["John"],
     *         transformations: {
     *             shift_dates: {
     *                 max_days: 5,
     *                 min_days: 1,
     *                 entity_types: ["date"]
     *             }
     *         }
     *     })
     */
    public deidentifyString(
        request: Skyflow.DeidentifyStringRequest,
        requestOptions?: Strings.RequestOptions,
    ): core.HttpResponsePromise<Skyflow.DeidentifyStringResponse> {
        return core.HttpResponsePromise.fromPromise(this.__deidentifyString(request, requestOptions));
    }

    private async __deidentifyString(
        request: Skyflow.DeidentifyStringRequest,
        requestOptions?: Strings.RequestOptions,
    ): Promise<core.WithRawResponse<Skyflow.DeidentifyStringResponse>> {
        const _response = await (this._options.fetcher ?? core.fetcher)({
            url: urlJoin(
                (await core.Supplier.get(this._options.baseUrl)) ??
                    (await core.Supplier.get(this._options.environment)) ??
                    environments.SkyflowEnvironment.Production,
                "v1/detect/deidentify/string",
            ),
            method: "POST",
            headers: {
                Authorization: await this._getAuthorizationHeader(),
                "X-Fern-Language": "JavaScript",
                "X-Fern-SDK-Name": "skyflow",
                "X-Fern-SDK-Version": "1.0.21",
                "User-Agent": "skyflow/1.0.21",
                "X-Fern-Runtime": core.RUNTIME.type,
                "X-Fern-Runtime-Version": core.RUNTIME.version,
                ...requestOptions?.headers,
            },
            contentType: "application/json",
            requestType: "json",
            body: request,
            timeoutMs: requestOptions?.timeoutInSeconds != null ? requestOptions.timeoutInSeconds * 1000 : 60000,
            maxRetries: requestOptions?.maxRetries,
            abortSignal: requestOptions?.abortSignal,
        });
        if (_response.ok) {
            return { data: _response.body as Skyflow.DeidentifyStringResponse, rawResponse: _response.rawResponse };
        }

        if (_response.error.reason === "status-code") {
            switch (_response.error.statusCode) {
                case 400:
                    throw new Skyflow.BadRequestError(_response.error.body as unknown, _response.rawResponse);
                case 401:
                    throw new Skyflow.UnauthorizedError(_response.error.body as unknown, _response.rawResponse);
                case 500:
                    throw new Skyflow.InternalServerError(
                        _response.error.body as Skyflow.ErrorResponse,
                        _response.rawResponse,
                    );
                default:
                    throw new errors.SkyflowError({
                        statusCode: _response.error.statusCode,
                        body: _response.error.body,
                        rawResponse: _response.rawResponse,
                    });
            }
        }

        switch (_response.error.reason) {
            case "non-json":
                throw new errors.SkyflowError({
                    statusCode: _response.error.statusCode,
                    body: _response.error.rawBody,
                    rawResponse: _response.rawResponse,
                });
            case "timeout":
                throw new errors.SkyflowTimeoutError(
                    "Timeout exceeded when calling POST /v1/detect/deidentify/string.",
                );
            case "unknown":
                throw new errors.SkyflowError({
                    message: _response.error.errorMessage,
                    rawResponse: _response.rawResponse,
                });
        }
    }

    /**
     * Re-identifies tokens in a string.
     *
     * @param {Skyflow.ReidentifyStringRequest} request
     * @param {Strings.RequestOptions} requestOptions - Request-specific configuration.
     *
     * @throws {@link Skyflow.BadRequestError}
     * @throws {@link Skyflow.UnauthorizedError}
     * @throws {@link Skyflow.InternalServerError}
     *
     * @example
     *     await client.strings.reidentifyString({
     *         text: "My name is [NAME_1], and my email is [EMAIL_1].",
     *         vault_id: "1ad6db07-8405-46cf-9a1e-db148ff9f4c5"
     *     })
     */
    public reidentifyString(
        request: Skyflow.ReidentifyStringRequest,
        requestOptions?: Strings.RequestOptions,
    ): core.HttpResponsePromise<Skyflow.ReidentifyStringResponse> {
        return core.HttpResponsePromise.fromPromise(this.__reidentifyString(request, requestOptions));
    }

    private async __reidentifyString(
        request: Skyflow.ReidentifyStringRequest,
        requestOptions?: Strings.RequestOptions,
    ): Promise<core.WithRawResponse<Skyflow.ReidentifyStringResponse>> {
        const _response = await (this._options.fetcher ?? core.fetcher)({
            url: urlJoin(
                (await core.Supplier.get(this._options.baseUrl)) ??
                    (await core.Supplier.get(this._options.environment)) ??
                    environments.SkyflowEnvironment.Production,
                "v1/detect/reidentify/string",
            ),
            method: "POST",
            headers: {
                Authorization: await this._getAuthorizationHeader(),
                "X-Fern-Language": "JavaScript",
                "X-Fern-SDK-Name": "skyflow",
                "X-Fern-SDK-Version": "1.0.21",
                "User-Agent": "skyflow/1.0.21",
                "X-Fern-Runtime": core.RUNTIME.type,
                "X-Fern-Runtime-Version": core.RUNTIME.version,
                ...requestOptions?.headers,
            },
            contentType: "application/json",
            requestType: "json",
            body: request,
            timeoutMs: requestOptions?.timeoutInSeconds != null ? requestOptions.timeoutInSeconds * 1000 : 60000,
            maxRetries: requestOptions?.maxRetries,
            abortSignal: requestOptions?.abortSignal,
        });
        if (_response.ok) {
            return { data: _response.body as Skyflow.ReidentifyStringResponse, rawResponse: _response.rawResponse };
        }

        if (_response.error.reason === "status-code") {
            switch (_response.error.statusCode) {
                case 400:
                    throw new Skyflow.BadRequestError(_response.error.body as unknown, _response.rawResponse);
                case 401:
                    throw new Skyflow.UnauthorizedError(_response.error.body as unknown, _response.rawResponse);
                case 500:
                    throw new Skyflow.InternalServerError(
                        _response.error.body as Skyflow.ErrorResponse,
                        _response.rawResponse,
                    );
                default:
                    throw new errors.SkyflowError({
                        statusCode: _response.error.statusCode,
                        body: _response.error.body,
                        rawResponse: _response.rawResponse,
                    });
            }
        }

        switch (_response.error.reason) {
            case "non-json":
                throw new errors.SkyflowError({
                    statusCode: _response.error.statusCode,
                    body: _response.error.rawBody,
                    rawResponse: _response.rawResponse,
                });
            case "timeout":
                throw new errors.SkyflowTimeoutError(
                    "Timeout exceeded when calling POST /v1/detect/reidentify/string.",
                );
            case "unknown":
                throw new errors.SkyflowError({
                    message: _response.error.errorMessage,
                    rawResponse: _response.rawResponse,
                });
        }
    }

    protected async _getAuthorizationHeader(): Promise<string> {
        return `Bearer ${await core.Supplier.get(this._options.token)}`;
    }
}
